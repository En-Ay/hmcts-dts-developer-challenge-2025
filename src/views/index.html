{% extends "layout.html" %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tag/macro.njk" import govukTag %}

{% block content %}
<style>
  /* Make buttons look exactly like standard GDS Table Headers */
  .govuk-table {
    table-layout: fixed;
    width: 100%;
  }
  
  /* Description Truncation */
  .app-description-truncate {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 4;
    line-clamp: 4;
    overflow: hidden;
  }
  

  /* Sort Button Styles */
  .app-table-sort-button {
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    font-family: "GDS Transport", arial, sans-serif;
    font-weight: 700;
    font-size: 1rem;
    color: inherit;
    text-align: left;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    position: relative;
  }

  .app-table-sort-button:hover {
    text-decoration: underline;
  }

  .app-table-sort-button:focus {
    outline: 3px solid #ffdd00;
    background-color: #ffdd00;
    color: #0b0c0c;
    box-shadow: 0 -2px #ffdd00, 0 4px #0b0c0c;
    text-decoration: none;
  }
</style>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full"> <h1 class="govuk-heading-xl">Caseworker Tasks</h1>

    {{ govukButton({
      text: "Create new task",
      href: "/create-task",
      isStartButton: true
    }) }}
    <form action="/" method="GET">
      <div class="govuk-grid-row govuk-!-margin-bottom-4 govuk-!-margin-top-4" style="background-color: #f3f2f1; padding: 20px 0;">
          
          <div class="govuk-grid-column-one-third">
            <div class="govuk-form-group govuk-!-margin-bottom-0">
              <fieldset class="govuk-fieldset">
                <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
                  Filter by status
                </legend>
                <div class="govuk-checkboxes govuk-checkboxes--small" data-module="govuk-checkboxes">
                  
                  <div class="govuk-checkboxes__item">
                    <input class="govuk-checkboxes__input" id="status-pending" name="status" type="checkbox" value="PENDING" 
                    {{ 'checked' if selectedStatus and 'PENDING' in selectedStatus }}>
                    <label class="govuk-label govuk-checkboxes__label" for="status-pending">
                      Pending
                    </label>
                  </div>

                  <div class="govuk-checkboxes__item">
                    <input class="govuk-checkboxes__input" id="status-progress" name="status" type="checkbox" value="IN_PROGRESS"
                    {{ 'checked' if selectedStatus and 'IN_PROGRESS' in selectedStatus }}>
                    <label class="govuk-label govuk-checkboxes__label" for="status-progress">
                      In Progress
                    </label>
                  </div>

                  <div class="govuk-checkboxes__item">
                    <input class="govuk-checkboxes__input" id="status-completed" name="status" type="checkbox" value="COMPLETED"
                    {{ 'checked' if selectedStatus and 'COMPLETED' in selectedStatus }}>
                    <label class="govuk-label govuk-checkboxes__label" for="status-completed">
                      Completed
                    </label>
                  </div>

                  <div class="govuk-checkboxes__item">
                    <input class="govuk-checkboxes__input" id="status-overdue" name="status" type="checkbox" value="OVERDUE"
                    {{ 'checked' if selectedStatus and 'OVERDUE' in selectedStatus }}>
                    <label class="govuk-label govuk-checkboxes__label" for="status-overdue">
                      Overdue
                    </label>
                  </div>

                </div>
              </fieldset>
            </div>
          </div>

          <div class="govuk-grid-column-one-third">
             <div class="govuk-form-group" style="margin-top: 25px;">
                <button type="submit" class="govuk-button" data-module="govuk-button">
                  Apply Filters
                </button>
                <a href="/" class="govuk-link govuk-link--no-visited-state govuk-!-margin-left-2" style="font-size: 19px; vertical-align: -webkit-baseline-middle;">
                  Clear
                </a>
             </div>
          </div>

      </div>
      
      <input type="hidden" name="sort" value="{{ currentSort }}">
      <input type="hidden" name="order" value="{{ currentOrder }}">
    </form>

      <div class="govuk-grid-column-one-third" id="overdue-stat-box" style="display: none;">
         <div class="govuk-form-group govuk-!-margin-bottom-0">
            <label class="govuk-label">
                <strong>Tasks Overdue</strong>
            </label>
            <span id="overdue-count" class="govuk-heading-l govuk-!-margin-bottom-0" style="color: #d4351c;">
              -
            </span>
        </div>
      </div>

    </div>

    <table class="govuk-table" id="task-table">
      <caption class="govuk-table__caption govuk-table__caption--m">
        Current Tasks 
        <span class="govuk-body-s govuk-!-font-weight-regular text-grey">
          (Showing up to next 100 due)
        </span>
      </caption>
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          
          {% set filterParams = "" %}
          {% for s in selectedStatus %}
            {% set filterParams = filterParams + "&status=" + s %}
          {% endfor %}

          <th scope="col" class="govuk-table__header" style="white-space: nowrap; width: 6%;">
            {% set nextOrder = 'DESC' if currentSort == 'id' and currentOrder == 'ASC' else 'ASC' %}
            <a href="/?sort=id&order={{ nextOrder }}{{ filterParams }}" class="app-table-sort-button">
              ID
              {% if currentSort == 'id' %}
                 {{ '▼' if currentOrder == 'DESC' else '▲' }}
              {% endif %}
            </a>
          </th>

          <th scope="col" class="govuk-table__header" style="width: 28%;">
            {% set nextOrder = 'DESC' if currentSort == 'title' and currentOrder == 'ASC' else 'ASC' %}
            <a href="/?sort=title&order={{ nextOrder }}{{ filterParams }}" class="app-table-sort-button">
              Title
              {% if currentSort == 'title' %}
                 {{ '▼' if currentOrder == 'DESC' else '▲' }}
              {% endif %}
            </a>
          </th>

          <th scope="col" class="govuk-table__header" style="width: 23%;">
            {% set nextOrder = 'DESC' if currentSort == 'description' and currentOrder == 'ASC' else 'ASC' %}
            <a href="/?sort=description&order={{ nextOrder }}{{ filterParams }}" class="app-table-sort-button">
              Description
              {% if currentSort == 'description' %}
                 {{ '▼' if currentOrder == 'DESC' else '▲' }}
              {% endif %}
            </a>
          </th>

          <th scope="col" class="govuk-table__header" style="white-space: nowrap; width: 12%;">
             {% set nextOrder = 'DESC' if currentSort == 'status' and currentOrder == 'ASC' else 'ASC' %}
            <a href="/?sort=status&order={{ nextOrder }}{{ filterParams }}" class="app-table-sort-button">
              Status
              {% if currentSort == 'status' %}
                 {{ '▼' if currentOrder == 'DESC' else '▲' }}
              {% endif %}
            </a>
          </th>

          <th scope="col" class="govuk-table__header" style="white-space: nowrap; width: 12%;">
             {% set nextOrder = 'DESC' if currentSort == 'due_date' and currentOrder == 'ASC' else 'ASC' %}
            <a href="/?sort=due_date&order={{ nextOrder }}{{ filterParams }}" class="app-table-sort-button">
              Due Date
              {% if currentSort == 'due_date' %}
                 {{ '▼' if currentOrder == 'DESC' else '▲' }}
              {% endif %}
            </a>
          </th>

          <th scope="col" class="govuk-table__header" style="white-space: nowrap; width: 5%;">Action</th>
        </tr>
      </thead>

      <tbody class="govuk-table__body" id="task-list-body">
        {% for task in tasks %}
          <tr class="govuk-table__row" data-status="{{ task.status }}">
            
            <td class="govuk-table__cell">{{ task.id }}</td>
            
            <td class="govuk-table__cell">
              <a href="/edit-task/{{ task.id }}" class="govuk-link" style="font-weight: bold;">{{ task.title }}</a>
            </td>

            <td class="govuk-table__cell govuk-table__cell--description">
              <div class="app-description-truncate">
                {{ task.description }}
              </div>
            </td>

            <td class="govuk-table__cell">
              {% if task.status == 'COMPLETED' %}
                  {{ govukTag({ text: "Completed", classes: "govuk-tag--green" }) }}
                {% elif task.status == 'IN_PROGRESS' %}
                  {{ govukTag({ text: "In Progress", classes: "govuk-tag--blue" }) }}
                {% else %}
                  {{ govukTag({ text: "Pending", classes: "govuk-tag--grey" }) }}
                {% endif %}
            </td>
            
            <td class="govuk-table__cell">
              <span class="js-local-date" data-iso="{{ task.due_date }}">
                {{ task.due_date | date }} 
              </span>
            </td>
            
            <td class="govuk-table__cell">
              <a href="/edit-task/{{ task.id }}" class="govuk-link">Edit</a>
            </td>
            
          </tr>
        {% else %}
          <tr class="govuk-table__row">
            <td class="govuk-table__cell" colspan="6" style="text-align: center;">No tasks found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>
</div>
{% endblock %}