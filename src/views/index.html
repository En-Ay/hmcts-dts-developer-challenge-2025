{% extends "layout.html" %}

{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/tag/macro.njk" import govukTag %}

{% block content %}
<style>
  /* Make buttons look exactly like standard GDS Table Headers */
  .govuk-table {
    table-layout: fixed;
    width: 100%;
  }
  
  /* Description Truncation */
  .app-description-truncate {
    display: -webkit-box;
    -webkit-box-orient: vertical;
    -webkit-line-clamp: 4;
    overflow: hidden;
  }
  

  /* Sort Button Styles */
  .app-table-sort-button {
    background: none;
    border: none;
    padding: 0;
    margin: 0;
    cursor: pointer;
    font-family: "GDS Transport", arial, sans-serif;
    font-weight: 700;
    font-size: 1rem;
    color: inherit;
    text-align: left;
    display: inline-flex;
    align-items: center;
    gap: 5px;
    position: relative;
  }

  .app-table-sort-button:hover {
    text-decoration: underline;
  }

  .app-table-sort-button:focus {
    outline: 3px solid #ffdd00;
    background-color: #ffdd00;
    color: #0b0c0c;
    box-shadow: 0 -2px #ffdd00, 0 4px #0b0c0c;
    text-decoration: none;
  }
</style>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-full"> <h1 class="govuk-heading-xl">Caseworker Tasks</h1>

    {{ govukButton({
      text: "Create new task",
      href: "/create-task",
      isStartButton: true
    }) }}

  <div class="govuk-grid-row govuk-!-margin-bottom-4 govuk-!-margin-top-4" style="background-color: #f3f2f1; padding: 20px 0;">
      
      <div class="govuk-grid-column-one-third">
        <div class="govuk-form-group govuk-!-margin-bottom-0">
          <fieldset class="govuk-fieldset">
            <legend class="govuk-fieldset__legend govuk-fieldset__legend--s">
              Filter by status
            </legend>
            <div class="govuk-checkboxes govuk-checkboxes--small" data-module="govuk-checkboxes">
              
              <div class="govuk-checkboxes__item">
                <input class="govuk-checkboxes__input filter-checkbox" id="status-pending" name="status" type="checkbox" value="PENDING" checked>
                <label class="govuk-label govuk-checkboxes__label" for="status-pending">
                  Pending
                </label>
              </div>

              <div class="govuk-checkboxes__item">
                <input class="govuk-checkboxes__input filter-checkbox" id="status-progress" name="status" type="checkbox" value="IN_PROGRESS" checked>
                <label class="govuk-label govuk-checkboxes__label" for="status-progress">
                  In Progress
                </label>
              </div>

              <div class="govuk-checkboxes__item">
                <input class="govuk-checkboxes__input filter-checkbox" id="status-completed" name="status" type="checkbox" value="COMPLETED">
                <label class="govuk-label govuk-checkboxes__label" for="status-completed">
                  Completed
                </label>
              </div>

              <div class="govuk-checkboxes__item">
                <input class="govuk-checkboxes__input filter-checkbox" id="status-overdue" name="status" type="checkbox" value="OVERDUE">
                <label class="govuk-label govuk-checkboxes__label" for="status-overdue">
                  Overdue
                </label>
              </div>

            </div>
          </fieldset>
        </div>
      </div>

      <div class="govuk-grid-column-one-third" id="overdue-stat-box" style="display: none;">
         <div class="govuk-form-group govuk-!-margin-bottom-0">
            <label class="govuk-label">
                <strong>Tasks Overdue</strong>
            </label>
            <span id="overdue-count" class="govuk-heading-l govuk-!-margin-bottom-0" style="color: #d4351c;">
              -
            </span>
        </div>
      </div>

    </div>

    <table class="govuk-table" id="task-table">
      <caption class="govuk-table__caption govuk-table__caption--m">
        Current Tasks 
        <span class="govuk-body-s govuk-!-font-weight-regular text-grey">
          (Showing up to next 100 due)
        </span>
      </caption>
      <thead class="govuk-table__head">
        <tr class="govuk-table__row">
          
          <th scope="col" class="govuk-table__header" style="white-space: nowrap; width: 6%;">
            <button id="sort-id" class="app-table-sort-button" onclick="sortTable('id')">ID</button>
          </th>

          <th scope="col" class="govuk-table__header" style="width: 28%;">
            <button id="sort-title" class="app-table-sort-button" onclick="sortTable('title')">Title</button>
          </th>

          <th scope="col" class="govuk-table__header" style="width: 23%;">
            <button id="sort-description" class="app-table-sort-button" onclick="sortTable('description')">Description</button>
          </th>

          <th scope="col" class="govuk-table__header" style="white-space: nowrap; width: 12%;">
            <button id="sort-status" class="app-table-sort-button" onclick="sortTable('status')">Status</button>
          </th>

          <th scope="col" class="govuk-table__header" style="white-space: nowrap; width: 12%;">
            <button id="sort-due_date" class="app-table-sort-button" onclick="sortTable('due_date')">Due Date</button>
          </th>

          <th scope="col" class="govuk-table__header" style="white-space: nowrap; width: 5%;">Action</th>
        </tr>
      </thead>

      <tbody class="govuk-table__body" id="task-list-body">
        {% for task in tasks %}
          <tr class="govuk-table__row" data-status="{{ task.status }}">
            
            <td class="govuk-table__cell">{{ task.id }}</td>
            
            <td class="govuk-table__cell">
              <a href="/edit-task/{{ task.id }}" class="govuk-link" style="font-weight: bold;">{{ task.title }}</a>
            </td>

            <td class="govuk-table__cell govuk-table__cell--description">
              <div class="app-description-truncate">
                {{ task.description }}
              </div>
            </td>

            <td class="govuk-table__cell">
              {% if task.status == 'COMPLETED' %}
                  {{ govukTag({ text: "Completed", classes: "govuk-tag--green" }) }}
                {% elif task.status == 'IN_PROGRESS' %}
                  {{ govukTag({ text: "In Progress", classes: "govuk-tag--blue" }) }}
                {% else %}
                  {{ govukTag({ text: "Pending", classes: "govuk-tag--grey" }) }}
                {% endif %}
            </td>
            
            <td class="govuk-table__cell">{{ task.due_date | replace("T", " ") }}</td>
            
            <td class="govuk-table__cell">
              <a href="/edit-task/{{ task.id }}" class="govuk-link">Edit</a>
            </td>
            
          </tr>
        {% else %}
          <tr class="govuk-table__row">
            <td class="govuk-table__cell" colspan="6" style="text-align: center;">No tasks found.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>

  </div>
</div>
{% endblock %}