{% extends "layout.html" %}
{% from "govuk/components/input/macro.njk" import govukInput %}
{% from "govuk/components/textarea/macro.njk" import govukTextarea %}
{% from "govuk/components/select/macro.njk" import govukSelect %}
{% from "govuk/components/button/macro.njk" import govukButton %}
{% from "govuk/components/back-link/macro.njk" import govukBackLink %}
{% from "govuk/components/character-count/macro.njk" import govukCharacterCount %}
{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% block content %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
    
    {% if errors and (errors | length > 0) %}
      {{ govukErrorSummary({
        titleText: "Error",
        errorList: [
          { text: errors.title[0], href: "#title" } if errors.title,
          { text: errors.description[0], href: "#description" } if errors.description,
          { text: errors.due_date[0], href: "#due_date" } if errors.due_date
        ]
      }) }}
    {% endif %}

  </div>
</div>
<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">

    <div class="govuk-error-summary" id="error-summary" aria-labelledby="error-summary-title" role="alert" tabindex="-1" style="display: none;">
      <h2 class="govuk-error-summary__title" id="error-summary-title">There is a problem</h2>
      <div class="govuk-error-summary__body">
        <ul class="govuk-list govuk-error-summary__list">
          <li id="summary-title-error" style="display: none;"><a href="#title">Enter a task title</a></li>
          <li id="summary-date-error" style="display: none;"><a href="#due_date">Enter a valid future due date</a></li>
        </ul>
      </div>
    </div>

    {{ govukBackLink({ text: "Back", href: "/" }) }}
    
    <h1 class="govuk-heading-xl">Create New Task</h1>

    <form action="/create-task" method="POST" novalidate>
      
      {{ govukInput({
        label: {
          text: "Task Title",
          classes: "govuk-label--l"
        },
        id: "title",
        name: "title",
        classes: "govuk-input--width-full",
        attributes: {
          maxlength: "100"
        },
        hint: {
          text: "Enter a brief title for the task (required)."
        },
        value: task.title, 
        errorMessage: { text: errors.title[0] } if errors.title else null
      }) }}

      {{ govukCharacterCount({
        name: "description",
        id: "description",
        maxlength: 2000,
        label: {
          text: "Description",
          classes: "govuk-label--m"
        },
        hint: {
          text: "Provide a detailed description of the task (optional)."
        },
        value: task.description
      }) }}

      {{ govukSelect({
        id: "status",
        name: "status",
        label: {
          text: "Status",
          classes: "govuk-label--m"
        },
        items: [
          { value: "PENDING", text: "Pending", selected: task.status == 'PENDING' },
          { value: "IN_PROGRESS", text: "In Progress", selected: task.status == 'IN_PROGRESS' },
          { value: "COMPLETED", text: "Completed", selected: task.status == 'COMPLETED' }
        ]
      }) }}

      <div class="govuk-form-group {% if errors.due_date %}govuk-form-group--error{% endif %}" id="due-date-group">
        <label class="govuk-label govuk-label--m" for="due_date">Due Date & Time</label>
        
        <div id="date-hint" class="govuk-hint">
          Enter a future date and time for when the task is due (required).
        </div>
        
        {% if errors.due_date %}
        <p class="govuk-error-message" id="due-date-error">
          <span class="govuk-visually-hidden">Error:</span> {{ errors.due_date[0] }}
        </p>
        {% endif %}

        <input class="govuk-input govuk-input--width-20 {% if errors.due_date %}govuk-input--error{% endif %}" 
               id="due_date" name="due_date" type="datetime-local" 
               aria-describedby="date-hint {% if errors.due_date %}due-date-error{% endif %}"
               value="{{ task.due_date }}">
      </div>

      {{ govukButton({ text: "Save Task" }) }}

    </form>
  </div>
</div>
{% endblock %}